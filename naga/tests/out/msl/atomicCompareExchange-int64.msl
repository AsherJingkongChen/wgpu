// language: metal1.0
#include <metal_stdlib>
#include <simd/simd.h>

using metal::uint;

struct type_2 {
    metal::atomic_long inner[128];
};
struct type_4 {
    metal::atomic_ulong inner[128];
};
struct _atomic_compare_exchange_resultSint8_ {
    long old_value;
    bool exchanged;
};
struct _atomic_compare_exchange_resultUint8_ {
    ulong old_value;
    bool exchanged;
};

namespace metal {
    template <
        typename _E = typename enable_if<
            _valid_compare_exchange_type<threadgroup int *>::value
        >::type
    >
    METAL_FUNC _atomic_compare_exchange_resultSint8_ atomic_naga_atomic_compare_exchange_weak_explicit(
        volatile threadgroup _atomic<int> *object,
        thread int *expected,
        int desired,
        memory_order success
    )
        METAL_CONST_ARG(success)
        METAL_COMPATIBLE_COMPARE_EXCHANGE_ORDERS(success, metal::memory_order_relaxed)
    {
        int next_expected(*expected);
        bool swapped = __metal_atomic_compare_exchange_weak_explicit(
            &object->__s,
            &next_expected,
            desired,
            int(success),
            int(metal::memory_order_relaxed),
            __METAL_MEMORY_SCOPE_THREADGROUP__
        );
        return _atomic_compare_exchange_resultSint8_{
            *expected = int(next_expected),
            swapped
        };
    }
    template <
        typename _E = typename enable_if<
            _valid_compare_exchange_type<device int *>::value
        >::type
    >
    METAL_FUNC _atomic_compare_exchange_resultSint8_ atomic_naga_atomic_compare_exchange_weak_explicit(
        volatile device _atomic<int> *object,
        thread int *expected,
        int desired,
        memory_order success
    )
        METAL_CONST_ARG(success)
        METAL_COMPATIBLE_COMPARE_EXCHANGE_ORDERS(success, metal::memory_order_relaxed)
    {
        int next_expected(*expected);
        bool swapped = __metal_atomic_compare_exchange_weak_explicit(
            &object->__s,
            &next_expected,
            desired,
            int(success),
            int(metal::memory_order_relaxed),
            __METAL_MEMORY_SCOPE_DEVICE__
        );
        return _atomic_compare_exchange_resultSint8_{
            *expected = int(next_expected),
            swapped
        };
    }
}

namespace metal {
    template <
        typename _E = typename enable_if<
            _valid_compare_exchange_type<threadgroup uint *>::value
        >::type
    >
    METAL_FUNC _atomic_compare_exchange_resultUint8_ atomic_naga_atomic_compare_exchange_weak_explicit(
        volatile threadgroup _atomic<uint> *object,
        thread uint *expected,
        uint desired,
        memory_order success
    )
        METAL_CONST_ARG(success)
        METAL_COMPATIBLE_COMPARE_EXCHANGE_ORDERS(success, metal::memory_order_relaxed)
    {
        uint next_expected(*expected);
        bool swapped = __metal_atomic_compare_exchange_weak_explicit(
            &object->__s,
            &next_expected,
            desired,
            int(success),
            int(metal::memory_order_relaxed),
            __METAL_MEMORY_SCOPE_THREADGROUP__
        );
        return _atomic_compare_exchange_resultUint8_{
            *expected = uint(next_expected),
            swapped
        };
    }
    template <
        typename _E = typename enable_if<
            _valid_compare_exchange_type<device uint *>::value
        >::type
    >
    METAL_FUNC _atomic_compare_exchange_resultUint8_ atomic_naga_atomic_compare_exchange_weak_explicit(
        volatile device _atomic<uint> *object,
        thread uint *expected,
        uint desired,
        memory_order success
    )
        METAL_CONST_ARG(success)
        METAL_COMPATIBLE_COMPARE_EXCHANGE_ORDERS(success, metal::memory_order_relaxed)
    {
        uint next_expected(*expected);
        bool swapped = __metal_atomic_compare_exchange_weak_explicit(
            &object->__s,
            &next_expected,
            desired,
            int(success),
            int(metal::memory_order_relaxed),
            __METAL_MEMORY_SCOPE_DEVICE__
        );
        return _atomic_compare_exchange_resultUint8_{
            *expected = uint(next_expected),
            swapped
        };
    }
}
constant uint SIZE = 128u;

kernel void test_atomic_compare_exchange_i64_(
  device type_2& arr_i64_ [[user(fake0)]]
) {
    uint i = 0u;
    long old = {};
    bool exchanged = {};
    bool loop_init = true;
    while(true) {
        if (!loop_init) {
            uint _e26 = i;
            i = _e26 + 1u;
        }
        loop_init = false;
        uint _e2 = i;
        if (_e2 < SIZE) {
        } else {
            break;
        }
        {
            uint _e6 = i;
            long _e8 = metal::atomic_load_explicit(&arr_i64_.inner[_e6], metal::memory_order_relaxed);
            old = _e8;
            exchanged = false;
            while(true) {
                bool _e12 = exchanged;
                if (!(_e12)) {
                } else {
                    break;
                }
                {
                    long _e14 = old;
                    long new_ = as_type<long>(_e14 + 10L);
                    uint _e19 = i;
                    long _e21 = old;
                    _atomic_compare_exchange_resultSint8_ _e22 = metal::atomic_naga_atomic_compare_exchange_weak_explicit(&arr_i64_.inner[_e19], &_e21, new_, metal::memory_order_relaxed);
                    old = _e22.old_value;
                    exchanged = _e22.exchanged;
                }
            }
        }
    }
    return;
}


kernel void test_atomic_compare_exchange_u64_(
  device type_4& arr_u64_ [[user(fake0)]]
) {
    uint i_1 = 0u;
    ulong old_1 = {};
    bool exchanged_1 = {};
    bool loop_init_1 = true;
    while(true) {
        if (!loop_init_1) {
            uint _e26 = i_1;
            i_1 = _e26 + 1u;
        }
        loop_init_1 = false;
        uint _e2 = i_1;
        if (_e2 < SIZE) {
        } else {
            break;
        }
        {
            uint _e6 = i_1;
            ulong _e8 = metal::atomic_load_explicit(&arr_u64_.inner[_e6], metal::memory_order_relaxed);
            old_1 = _e8;
            exchanged_1 = false;
            while(true) {
                bool _e12 = exchanged_1;
                if (!(_e12)) {
                } else {
                    break;
                }
                {
                    ulong _e14 = old_1;
                    ulong new_1 = as_type<ulong>(_e14 + 10uL);
                    uint _e19 = i_1;
                    ulong _e21 = old_1;
                    _atomic_compare_exchange_resultUint8_ _e22 = metal::atomic_naga_atomic_compare_exchange_weak_explicit(&arr_u64_.inner[_e19], &_e21, new_1, metal::memory_order_relaxed);
                    old_1 = _e22.old_value;
                    exchanged_1 = _e22.exchanged;
                }
            }
        }
    }
    return;
}
